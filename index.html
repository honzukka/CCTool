<!DOCTYPE html>
<html lang="en">
<head>
	<title>CC Tool</title>
	<meta charset="utf-8">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="additional_styles.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<div class="container">
	<h1>CC Tool</h1>
	<br><br>
	<form enctype="multipart/form-data">
		<h4>Select a file to upload:</h4>
		<br>
		<div class="form-group">
			<p class="text-muted" id="filenameDisplay">No file selected</p>
			<label class="btn btn-default">
				Browse <input type="file" id="fileUpload" name="fileUpload" hidden />
			</label>
		</div>
		<div class="form-group">
			<button type="button" class="btn btn-default" id="submitButton" disabled="true">Upload</button>
		</div>
	</form>
	<br><br>
	<pre id="response"></pre>
</div>

<script>
$("#response").hide();

// place any file checks here - this will be called whenever the file to upload changes
$("#fileUpload").on("change", function(){
	var file = this.files[0];
	
	// if the file picker was cancelled
	if (file == null)
	{
		$("#filenameDisplay").html("No file selected");
		$("#submitButton").prop("disabled", true);
		return;
	}
	
	// if the file type is wrong
	if (file.type != "text/xml" && file.type != "text/plain")
	{
		// no need to reset the form because the 'upload' button is disabled anyway
		alert("Unsupported file type. Supported file types: .txt, .xml");
		$("#filenameDisplay").html("No file selected");
		$("#submitButton").prop("disabled", true);
		return;
	}
	
	$("#filenameDisplay").html(file.name);
	$("#submitButton").prop("disabled", false);
});

$("#submitButton").on("click", function(){
	$("#submitButton").prop("disabled", true);
	$.ajax({
		url: "process_mastercard.php",
		method: "POST",
		
		// intialize FormData with a file from the form
		data: new FormData($("form")[0]),
		
		cache: false,
		contentType: false,
		processData: false,

		// this callback receives data from the php code
		success: function(data){
			$("#submitButton").prop("disabled", false);
			$("#response").show();
			//$("#response").html(JSON.stringify(data));
			var obj = JSON.parse(data);
			if (obj.Error != "")
			{
				$("#response").html(obj.Error);
				return;
			}
			
			//$("#response").html(JSON.stringify(obj, undefined, 2));
			var view = buildView(obj);
			
			// show the view
			$("#response").html(view);
		}
	});
});

// generates html code with collapsibles based on the json and returns it
function buildView(objJson)
{
	var accounts = objJson.Accounts;
	
	// HTML 01 - open a panel group for the view
	var viewHTML = "<div class='panel-group'>";
	
	var accountCounter = 1;
	for (var account in accounts)
	{
		// HTML 02 - each account header is shown in a collapsible panel
		var panelId = "collapseAccount" + accountCounter;
		var panelText = accounts[account]["Account Panel Text"];
		var accountViewHTML = GetCollapsibleHeaderPanelOpening(panelId, panelText);

		// insert account items into the collapsible area of the account header panel
		$.each(accounts[account], function(accountItemName, accountItemValue){
		
			// add simple items
			if (accountItemName != "Transactions" && accountItemName != "Account Panel Text" && accountItemValue != "")
			{
				accountViewHTML += "<li class='list-group-item'><strong>" + accountItemName + "</strong>: <mark>" + accountItemValue +  "</mark></li>";
			}
			// transactions have another collapsible header panel
			else if (accountItemName == "Transactions")
			{
				// HTML 03
				accountViewHTML += "<li class='list-group-item'>";
				
				// HTML 04 - open the collapsible header panel for transactions
				var panelId = "collapseTransactions" + accountCounter;
				var panelText = "Transactions (" + Object.keys(accountItemValue).length + ")";
				accountViewHTML += GetCollapsibleHeaderPanelOpening(panelId, panelText);

				var transactionCounter = 1;
				for (var transaction in accountItemValue)
				{
					// HTML 05 - each transaction has another collapsible panel header
					var panelId = "collapseTransaction" + accountCounter + "-" + transactionCounter;
					var panelText = accountItemValue[transaction]["Transaction Panel Text"];
					accountViewHTML += GetCollapsibleHeaderPanelOpening(panelId, panelText);

					// insert transaction items into the collapsible area of each transaction header panel
					$.each(accountItemValue[transaction], function(transactionItemName, transactionItemValue){
						if (transactionItemName != "Transaction Panel Text" && transactionItemValue != "")
						{
							accountViewHTML += "<li class='list-group-item'><strong>" + transactionItemName + "</strong>: <mark>" + transactionItemValue +  "</mark></li>";
						}
					});
					
					// HTML 05 - close the collapsible header panel for each transaction
					accountViewHTML += GetCollapsibleHeaderPanelClosing();
					transactionCounter++;
				}
				
				// HTML 04 - close the transactions header panel
				accountViewHTML += GetCollapsibleHeaderPanelClosing();
				
				// HTML 03
				accountViewHTML += "</li>";
			}
		});
		
		// HTML 02 - close the account header panel
		accountViewHTML += GetCollapsibleHeaderPanelClosing();
		
		viewHTML += accountViewHTML;
		accountCounter++;
	}
	
	// HTML 01 - close the panel group
	viewHTML += "</div>";
	
	return viewHTML;
}

function GetCollapsibleHeaderPanelOpening(panelId, panelText)
{
	return "" +
		"<div class='panel panel-default'>" +
			"<div class='panel-heading'>" +
				"<p class='panel-title'>" +
					"<a data-toggle='collapse' href='#" + panelId + "'>" + panelText + "</a>" +
				"</p>" +
			"</div>" +
			"<div id='" + panelId + "' class='panel-collapse collapse'>" +
				"<ul class='list-group'>";
}

function GetCollapsibleHeaderPanelClosing()
{
	return "</ul>" + "</div>" + "</div>";
}

/* EXPECTED JSON FORMAT
{
	"Error": "error_message",   <--- error_message is empty if no error has occured
	"Accounts": [
		{ 
			"Account Panel Text": "text",
			"AccountItem1": "AccountItem1Value",
			...,
			"Transactions": [ 
				{ 
					"Transaction Panel Text": "text",
					"TransactionItem1": "TransactionItem1Value",
					...
				},
				... 
			]
		},
		...
	]
}
*/
</script>

</body>
</html>