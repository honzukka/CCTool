<!DOCTYPE html>
<html lang="en">
<head>
	<title>CC Analyzer</title>
	<meta charset="utf-8">
	<link rel="stylesheet" href="bootstrap-custom/css/bootstrap.min.css">
	<link rel="stylesheet" href="additional_styles.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="bootstrap-custom/js/bootstrap.min.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<div class="container">
	<h1>CC Analyzer</h1>
	<br><br>
	<form enctype="multipart/form-data" id="form">
		
		<label for="fileToUpload">Select a file to upload:</label>
		<div class="form-group">
			<p class="text-muted" id="filenameDisplay">No file selected</p>
			<label class="btn btn-default">
				Browse <input type="file" id="fileUpload" name="fileUpload" hidden />
			</label>
			<br><br>
			<div class="row">
				<div class="col-md-3 col-sm-4 col-xs-5">
					<label for="seltype">Select file type:</label>
					<select class="form-control" id="seltype" name="seltype">
						<option value="mc">Mastercard CDF 3.0</option>
						<option value="v40">VISA VCF 4.0</option>
						<option value="v44">VISA VCF 4.4</option>
					</select>
				</div>
				<div class="col-md-9 col-sm-8 col-xs-7"></div>
			</div>
			<br>
			<div class="form-group">
				<button type="button" class="btn btn-default" id="submitButton" disabled="true">Upload</button>
			</div>
		</div>
	</form>
	<br><br>
	<pre id="response"></pre>
</div>

<script>
$("#response").hide();

// place any file checks here - this will be called whenever the file to upload changes
$("#fileUpload").on("change", function(){
	var file = this.files[0];
	
	// if the file picker was cancelled
	if (file == null)
	{
		$("#filenameDisplay").html("No file selected");
		$("#submitButton").prop("disabled", true);
		return;
	}
	
	// if the file type is wrong
	if (file.type != "text/xml" && file.type != "text/plain")
	{
		// no need to reset the form because the 'upload' button is disabled anyway
		alert("Unsupported file type. Supported file types: .txt, .xml");
		$("#filenameDisplay").html("No file selected");
		$("#submitButton").prop("disabled", true);
		return;
	}
	
	$("#filenameDisplay").html(file.name);
	$("#submitButton").prop("disabled", false);
});

$("#submitButton").on("click", function(){
	$("#submitButton").prop("disabled", true);
	$.ajax({
		url: "upload_and_process.php",
		method: "POST",
		
		// intialize FormData with a file from the form
		data: new FormData($("#form")[0]),
		
		cache: false,
		contentType: false,
		processData: false,

		// this callback receives data from the php code
		success: function(data){
			$("#submitButton").prop("disabled", false);
			$("#response").show();
			//$("#response").html(data);

			var obj;
			try
			{
				obj = JSON.parse(data);
				
				if (obj.Error != "")
				{
					$("#response").html("Processing error:\n" + obj.Error);
					return;
				}
			}
			catch (err)
			{
				var output = "Invalid JSON received.\n" +
								"Error message: " + err + "\n" +
								"Data Received:\n" + data;
				$("#response").html(output);
				return;
			}
			
			//$("#response").html(JSON.stringify(obj, undefined, 2));
			var view = buildView(obj);
			
			// show the view
			$("#response").html(view);
		}
	});
});

// generates html code with collapsibles based on the json and returns it
function buildView(objJson)
{
	switch ($("#seltype").val())
	{
		case "mc":
			return buildViewMastercard(objJson);
		case "v40":
			return buildViewVisa(objJson);
		case "v44":
			return buildViewVisa(objJson);
		default:
			return "error";
	}
}

// generates html code with collapsibles based on sections in a Visa file
function buildViewVisa(objJson)
{
	// HTML 01 - open a panel group for the view
	var viewHTML = "<div class='panel-group'>";
	
	// HTML 02 - each section is shown in a collapsible panel
	viewHTML += GetCollapsibleHeaderPanelOpening("collapseCardholders", "Cardholders (" + Object.keys(objJson.Cardholders).length + ")", "panel-primary");
	viewHTML += "<li class='list-group-item'><h4><em>" + objJson.CardholdersMeta + "</em></h4></li>";
	viewHTML += buildViewSection(objJson.Cardholders, "Cardholders");
	viewHTML += GetCollapsibleHeaderPanelClosing();
	
	viewHTML += GetCollapsibleHeaderPanelOpening("collapseAccounts", "Accounts (" + Object.keys(objJson.Accounts).length + ")", "panel-primary");
	viewHTML += "<li class='list-group-item'><h4><em>" + objJson.AccountsMeta + "</em></h4></li>";
	viewHTML += buildViewSection(objJson.Accounts, "Accounts");
	viewHTML += GetCollapsibleHeaderPanelClosing();
	
	viewHTML += GetCollapsibleHeaderPanelOpening("collapseTransactions", "Transactions (" + Object.keys(objJson.Transactions).length + ")", "panel-primary");
	viewHTML += "<li class='list-group-item'><h4><em>" + objJson.TransactionsMeta + "</em></h4></li>";
	viewHTML += buildViewSection(objJson.Transactions, "Transactions");
	viewHTML += GetCollapsibleHeaderPanelClosing();
	
	// HTML 01 - close the panel group
	viewHTML += "</div>";
	
	return viewHTML;
}

// generates html code with collapsibles based on sections in a Mastercard file
function buildViewMastercard(objJson)
{
	// HTML 01 - open a panel group for the view
	var viewHTML = "<div class='panel-group'>";
	
	// HTML 02 - each section is shown in a collapsible panel
	viewHTML += GetCollapsibleHeaderPanelOpening("collapseCardholders", "Accounts (" + Object.keys(objJson.Accounts).length + ")", "panel-primary");
	viewHTML += "<li class='list-group-item'><h4><em>" + objJson.AccountsMeta + "</em></h4></li>";
	viewHTML += buildViewSection(objJson.Accounts, "Accounts");
	viewHTML += GetCollapsibleHeaderPanelClosing();
	
	// HTML 01 - close the panel group
	viewHTML += "</div>";
	
	return viewHTML;
}

// generates html code for a section (i.e. a list of objects containing fields and optionally a Transactions section)
// see expected JSON format below
function buildViewSection(section, sectionName)
{
	var viewHTML = "";
	
	var itemCounter = 1;
	for (var item in section)
	{
		// HTML 03 - each account header is shown in a collapsible panel
		var panelId = "collapse" + sectionName + itemCounter;
		var panelText = section[item]["Collapsible Panel Text"];
		var itemViewHTML = GetCollapsibleHeaderPanelOpening(panelId, panelText, "panel-default");

		// insert account items into the collapsible area of the account header panel
		$.each(section[item], function(itemName, itemValue){
		
			// add simple items
			if (itemName != "Transactions" && itemName != "Collapsible Panel Text" && itemName != "TransactionsMeta" && itemValue != "")
			{
				itemViewHTML  += "<li class='list-group-item'><strong>" + itemName + "</strong>: <mark>" + itemValue +  "</mark></li>";
			}
			// transactions have another collapsible header panel
			else if (itemName == "Transactions")
			{
				// HTML 04
				itemViewHTML  += "<li class='list-group-item'>";
				
				// HTML 05 - open the collapsible header panel for transactions
				var panelId = "collapseTransactions" + itemCounter;
				var panelText = "Transactions (" + Object.keys(itemValue).length + ")";
				itemViewHTML  += GetCollapsibleHeaderPanelOpening(panelId, panelText, "panel-primary");
				itemViewHTML += "<li class='list-group-item'><h4><em>" + section[item]["TransactionsMeta"] + "</em></h4></li>";

				var transactionCounter = 1;
				for (var transaction in itemValue)
				{
					// HTML 06 - each transaction has another collapsible panel header
					var panelId = "collapseTransaction" + itemCounter + "-" + transactionCounter;
					var panelText = itemValue[transaction]["Collapsible Panel Text"];
					itemViewHTML  += GetCollapsibleHeaderPanelOpening(panelId, panelText, "panel-default");

					// insert transaction items into the collapsible area of each transaction header panel
					$.each(itemValue[transaction], function(transactionItemName, transactionItemValue){
						if (transactionItemName != "Collapsible Panel Text" && transactionItemValue != "")
						{
							itemViewHTML  += "<li class='list-group-item'><strong>" + transactionItemName + "</strong>: <mark>" + transactionItemValue +  "</mark></li>";
						}
					});
					
					// HTML 06 - close the collapsible header panel for each transaction
					itemViewHTML  += GetCollapsibleHeaderPanelClosing();
					transactionCounter++;
				}
				
				// HTML 05 - close the transactions header panel
				itemViewHTML  += GetCollapsibleHeaderPanelClosing();
				
				// HTML 04
				itemViewHTML  += "</li>";
			}
		});
		
		// HTML 03 - close the account header panel
		itemViewHTML += GetCollapsibleHeaderPanelClosing();
		
		viewHTML += itemViewHTML;
		itemCounter++;
	}
	
	return viewHTML;
}

function GetCollapsibleHeaderPanelOpening(panelId, panelText, panelClassString)
{
	return "" +
		"<div class='panel " + panelClassString + "'>" +
			"<div class='panel-heading'>" +
				"<p class='panel-title'>" +
					"<a data-toggle='collapse' href='#" + panelId + "'>" + panelText + "</a>" +
				"</p>" +
			"</div>" +
			"<div id='" + panelId + "' class='panel-collapse collapse'>" +
				"<ul class='list-group'>";
}

function GetCollapsibleHeaderPanelClosing()
{
	return "</ul>" + "</div>" + "</div>";
}

/* EXPECTED JSON FORMAT
{
	"Error": "error_message",   <--- error_message is empty if no error has occured
	"Accounts": [
		{ 
			"Collapsible Panel Text": "header text",
			"Item1": "Item1Value",
			...,
			
			***** TRANSACTIONS ONLY FOR MASTERCARD *****
			
			"Transactions": [ 
				{ 
					"Collapsible Panel Text": "text",
					"Item1": "Item1Value",
					...
				},
				... 
			],
			"TransactionsMeta": "meta_string"	<--- this string describes the format of collapsible panel texts
		},
		...
	],
	"AccountsMeta": "meta_string",	<--- this string describes the format of collapsible panel texts
	
	***** BELOW FIELDS ONLY FOR VISA *****
	
	"Cardholders": [
		{
			"Collapsible Panel Text": "header text",
			"Item1": "Item1Value",
			...
		}
	],
	"CardholdersMeta": "meta_string",	<--- this string describes the format of collapsible panel texts
	"Transactions": [
		{
			"Collapsible Panel Text": "header text",
			"Item1": "Item1Value",
			...
		}
	],
	"TransactionsMeta": "meta_string",	<--- this string describes the format of collapsible panel texts
}
*/
</script>

</body>
</html>